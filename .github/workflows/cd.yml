name: Deploy

on:
  workflow_run:
    workflows: [ "CI/CD Pipeline" ]
    types: [ completed ]
    branches: [ master, develop, development ]
  workflow_dispatch:

env:
  JAVA_VERSION: '25'

jobs:
  # Deploy to DEV (automatic on development branch)
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'development'

    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Build application
        run: mvn clean package -DskipTests

      - name: Deploy to DEV
        run: |
          echo "ğŸš€ Deploying to DEV Environment"
          echo "Build: #${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: development"
          # TODO: Add your DEV deployment command here
          # Example: scp target/JwtExample-*.jar user@dev-server:/opt/apps/
          # Example: ssh user@dev-server 'systemctl restart jwt-example'

      - name: Health Check - DEV
        run: |
          echo "ğŸ” Checking DEV deployment health..."
          # TODO: Update with your DEV health check endpoint
          # Example: curl -f http://dev-server:8080/api/health || exit 1
          echo "âœ… DEV health check passed"

      - name: Notify Success
        if: success()
        run: echo "âœ… Successfully deployed to DEV"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ DEV deployment failed"

  # Deploy to Staging (automatic on develop branch)
  deploy-staging:
    name: Deploy to STAGING
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop'

    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Build application
        run: mvn clean package -DskipTests

      - name: Deploy to STAGING
        run: |
          echo "ğŸš€ Deploying to STAGING Environment"
          echo "Build: #${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: develop"
          # TODO: Add your STAGING deployment command here
          # Example: scp target/JwtExample-*.jar user@staging-server:/opt/apps/
          # Example: ssh user@staging-server 'systemctl restart jwt-example'

      - name: Health Check - STAGING
        run: |
          echo "ğŸ” Checking STAGING deployment health..."
          # TODO: Update with your STAGING health check endpoint
          # Example: curl -f http://staging-server:8080/api/health || exit 1
          echo "âœ… STAGING health check passed"

      - name: Notify Success
        if: success()
        run: echo "âœ… Successfully deployed to STAGING"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ STAGING deployment failed"

  # Deploy to Production (requires approval on master branch)
  deploy-production:
    name: Deploy to PRODUCTION
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master'

    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Build application
        run: mvn clean package -DskipTests

      - name: Deploy to PRODUCTION
        run: |
          echo "ğŸš€ Deploying to PRODUCTION Environment"
          echo "Build: #${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: master"
          # TODO: Add your PRODUCTION deployment command here
          # Example: scp target/JwtExample-*.jar user@prod-server:/opt/apps/
          # Example: ssh user@prod-server 'systemctl restart jwt-example'

      - name: Health Check - PRODUCTION
        run: |
          echo "ğŸ” Checking PRODUCTION deployment health..."
          # TODO: Update with your PRODUCTION health check endpoint
          # Example: curl -f http://prod-server:8080/api/health || exit 1
          echo "âœ… PRODUCTION health check passed"

      - name: Notify Success
        if: success()
        run: echo "âœ… Successfully deployed to PRODUCTION"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ PRODUCTION deployment failed"

  # Deployment Status Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [ deploy-dev, deploy-staging, deploy-production ]

    steps:
      - name: Print Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  DEPLOYMENT SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "DEV:        ${{ needs.deploy-dev.result }}"
          echo "STAGING:    ${{ needs.deploy-staging.result }}"
          echo "PRODUCTION: ${{ needs.deploy-production.result }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Branch: ${{ github.event.workflow_run.head_branch }}"
          echo "Build: #${{ github.run_number }}"
          echo "Repository: ${{ github.repository }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"


